<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vbp-parana/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Dashboard do Valor Bruto da Producao Agropecuaria do Parana para analise territorial." />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href="https://avnergomes.github.io/vbp-parana/" />
    <title>VBP Parana | Avner Gomes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  </head>
  <body class="antialiased">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script>
(function() {
  const TRACKING_URL = 'https://script.google.com/macros/s/AKfycbzT3O9M4tN-eYXLXoxAH9v2zdjfqFm0URPQrEPvnl1ZsVqXaJyb7QHDHnYDSJSRoacnYA/exec';
  const DEBUG = true; // Mude para false em produÃ§Ã£o

  function log(message, data) {
    if (DEBUG) {
      console.log('[VBP Tracking]', message, data || '');
    }
  }

  function getSessionId() {
    let sessionId = sessionStorage.getItem('vbp_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('vbp_session_id', sessionId);
      log('Novo sessionId criado:', sessionId);
    } else {
      log('SessionId existente:', sessionId);
    }
    return sessionId;
  }

  function trackVisit(page) {
    // Get performance metrics
    const perfTiming = performance.timing;
    const perfEntries = performance.getEntriesByType ? performance.getEntriesByType('navigation')[0] : null;
    const paintEntries = performance.getEntriesByType ? performance.getEntriesByType('paint') : [];

    // Get UTM parameters
    const urlParams = new URLSearchParams(window.location.search);
    const utmSource = urlParams.get('utm_source') || '';
    const utmMedium = urlParams.get('utm_medium') || '';
    const utmCampaign = urlParams.get('utm_campaign') || '';
    const utmTerm = urlParams.get('utm_term') || '';
    const utmContent = urlParams.get('utm_content') || '';

    // Detect returning visitor
    const returningVisitor = (function() {
      try {
        const hasVisitedBefore = localStorage.getItem('vbp_has_visited');
        if (!hasVisitedBefore) {
          // Primeira visita - marcar para futuras visitas
          localStorage.setItem('vbp_has_visited', 'true');
          localStorage.setItem('vbp_first_visit', new Date().toISOString());
          return false;
        }
        return true;
      } catch(e) {
        // Se localStorage nÃ£o estiver disponÃ­vel, assumir que nÃ£o Ã© returning visitor
        return false;
      }
    })();

    const visitData = {
      // Dados bÃ¡sicos
      page: page || window.location.pathname + window.location.hash,
      referrer: document.referrer || 'direto',
      userAgent: navigator.userAgent,
      language: navigator.language,
      screenWidth: screen.width,
      screenHeight: screen.height,
      platform: navigator.platform,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      sessionId: getSessionId(),
      timestamp: new Date().toISOString(),
      returningVisitor: returningVisitor,

      // Dispositivo
      colorDepth: screen.colorDepth || null,
      pixelRatio: window.devicePixelRatio || 1,
      viewportWidth: window.innerWidth || null,
      viewportHeight: window.innerHeight || null,
      touchSupport: navigator.maxTouchPoints > 0,
      cpuCores: navigator.hardwareConcurrency || null,
      deviceMemory: navigator.deviceMemory || null,

      // Navegador
      vendor: navigator.vendor || 'unknown',
      cookiesEnabled: navigator.cookieEnabled,
      doNotTrack: navigator.doNotTrack === "1",
      onlineStatus: navigator.onLine,

      // ConexÃ£o (se disponÃ­vel)
      connectionType: navigator.connection?.effectiveType || 'unknown',
      connectionSpeed: navigator.connection?.downlink || null,
      saveDataMode: navigator.connection?.saveData || false,

      // URL/PÃ¡gina
      protocol: window.location.protocol,
      hostname: window.location.hostname,
      pathname: window.location.pathname,
      queryString: window.location.search || '',
      pageTitle: document.title,

      // Performance
      loadTime: performance.timing.loadEventEnd > 0 ?
        performance.timing.loadEventEnd - performance.timing.navigationStart : null,

      // OrientaÃ§Ã£o
      screenOrientation: screen.orientation?.type || 'unknown',

      // Timezone offset
      timezoneOffset: new Date().getTimezoneOffset(),

      // === NOVOS DADOS COLETADOS (adicionados Ã  direita) ===

      // Performance detalhada
      dnsLookupTime: perfTiming.domainLookupEnd > 0 ? perfTiming.domainLookupEnd - perfTiming.domainLookupStart : null,
      tcpConnectionTime: perfTiming.connectEnd > 0 ? perfTiming.connectEnd - perfTiming.connectStart : null,
      serverResponseTime: perfTiming.responseEnd > 0 ? perfTiming.responseEnd - perfTiming.requestStart : null,
      domContentLoadedTime: perfTiming.domContentLoadedEventEnd > 0 ? perfTiming.domContentLoadedEventEnd - perfTiming.navigationStart : null,
      domInteractiveTime: perfTiming.domInteractive > 0 ? perfTiming.domInteractive - perfTiming.navigationStart : null,
      firstPaint: paintEntries.find(e => e.name === 'first-paint')?.startTime || null,
      firstContentfulPaint: paintEntries.find(e => e.name === 'first-contentful-paint')?.startTime || null,
      transferSize: perfEntries?.transferSize || null,
      encodedBodySize: perfEntries?.encodedBodySize || null,
      decodedBodySize: perfEntries?.decodedBodySize || null,

      // ConexÃ£o detalhada
      connectionRTT: navigator.connection?.rtt || null,
      connectionDownlinkMax: navigator.connection?.downlinkMax || null,

      // Capacidades do navegador
      languages: navigator.languages ? navigator.languages.join(',') : navigator.language,
      localStorageEnabled: (function() {
        try { return !!window.localStorage; } catch(e) { return false; }
      })(),
      sessionStorageEnabled: (function() {
        try { return !!window.sessionStorage; } catch(e) { return false; }
      })(),
      indexedDBEnabled: !!window.indexedDB,
      serviceWorkerEnabled: 'serviceWorker' in navigator,
      webGLSupported: (function() {
        try {
          const canvas = document.createElement('canvas');
          return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
        } catch(e) { return false; }
      })(),
      webRTCSupported: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
      notificationPermission: 'Notification' in window ? Notification.permission : 'not-supported',

      // Plugins e MIME types
      pluginsCount: navigator.plugins ? navigator.plugins.length : 0,
      mimeTypesCount: navigator.mimeTypes ? navigator.mimeTypes.length : 0,
      pdfViewerEnabled: navigator.pdfViewerEnabled || false,

      // Hardware adicional
      maxTouchPoints: navigator.maxTouchPoints || 0,
      batteryLevel: null, // SerÃ¡ preenchido assincronamente se disponÃ­vel
      batteryCharging: null, // SerÃ¡ preenchido assincronamente se disponÃ­vel

      // Contexto de navegaÃ§Ã£o
      historyLength: window.history.length,
      isIframe: window.self !== window.top,

      // Marketing e UTM
      utmSource: utmSource,
      utmMedium: utmMedium,
      utmCampaign: utmCampaign,
      utmTerm: utmTerm,
      utmContent: utmContent,

      // InformaÃ§Ãµes de sessÃ£o
      sessionStartTime: sessionStorage.getItem('vbp_session_start') || (function() {
        const start = new Date().toISOString();
        sessionStorage.setItem('vbp_session_start', start);
        return start;
      })(),
      pageViewsInSession: parseInt(sessionStorage.getItem('vbp_page_views') || '0') + 1,

      // Dispositivo mÃ³vel e tipo
      isMobile: /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
      isTablet: /iPad|Android(?!.*Mobile)/i.test(navigator.userAgent),
      isDesktop: !/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),

      // Aspectos de seguranÃ§a e privacidade
      secureContext: window.isSecureContext || false,
      crossOriginIsolated: window.crossOriginIsolated || false,

      // RenderizaÃ§Ã£o
      canvasSupported: !!document.createElement('canvas').getContext,
      svgSupported: !!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', 'svg').createSVGRect,

      // Armazenamento
      storageQuota: null, // SerÃ¡ preenchido assincronamente se disponÃ­vel

      // Tamanho disponÃ­vel da tela (descontando barras do sistema)
      availScreenWidth: screen.availWidth || null,
      availScreenHeight: screen.availHeight || null,

      // Modo de exibiÃ§Ã£o
      displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' :
                   window.matchMedia('(display-mode: fullscreen)').matches ? 'fullscreen' :
                   window.matchMedia('(display-mode: minimal-ui)').matches ? 'minimal-ui' : 'browser',

      // PreferÃªncias do usuÃ¡rio
      prefersColorScheme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' :
                         window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'no-preference',
      prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
      prefersReducedTransparency: window.matchMedia('(prefers-reduced-transparency: reduce)').matches,
      prefersContrast: window.matchMedia('(prefers-contrast: high)').matches ? 'high' :
                      window.matchMedia('(prefers-contrast: low)').matches ? 'low' : 'no-preference'
    };

    // Atualizar contador de page views da sessÃ£o
    sessionStorage.setItem('vbp_page_views', visitData.pageViewsInSession.toString());

    // Coletar dados assÃ­ncronos (battery e storage)
    const asyncPromises = [];

    // Battery API
    if ('getBattery' in navigator) {
      asyncPromises.push(
        navigator.getBattery().then(battery => {
          visitData.batteryLevel = battery.level;
          visitData.batteryCharging = battery.charging;
        }).catch(() => {
          // Ignorar erro silenciosamente
        })
      );
    }

    // Storage Quota API
    if ('storage' in navigator && 'estimate' in navigator.storage) {
      asyncPromises.push(
        navigator.storage.estimate().then(estimate => {
          visitData.storageQuota = estimate.quota || null;
          visitData.storageUsage = estimate.usage || null;
          visitData.storageUsagePercent = estimate.quota ? (estimate.usage / estimate.quota * 100).toFixed(2) : null;
        }).catch(() => {
          // Ignorar erro silenciosamente
        })
      );
    }

    // Aguardar coleta assÃ­ncrona antes de enviar
    Promise.all(asyncPromises).finally(() => {
      log('Enviando dados:', visitData);

      // Enviar dados sem esperar resposta (fire and forget)
      try {
        fetch(TRACKING_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(visitData),
          keepalive: true
        }).then(() => {
          log('Dados enviados');
        }).catch(() => {
          // Silenciar erros de tracking para nÃ£o impactar a aplicaÃ§Ã£o
          log('Tracking enviado (erro ignorado)');
        });
      } catch (e) {
        // Silenciar qualquer erro
        log('Tracking error (ignorado):', e.message);
      }
    });
  }

  // Rastrear visita inicial
  log('Inicializando rastreamento');
  trackVisit();

  // Rastrear mudanÃ§as de hash (para rotas #hash)
  window.addEventListener('hashchange', function() {
    log('Hash mudou');
    trackVisit();
  });

  // Rastrear mudanÃ§as de rota no React Router (popstate)
  window.addEventListener('popstate', function() {
    log('Popstate disparado');
    setTimeout(() => trackVisit(), 100);
  });

  // Interceptar pushState e replaceState para React Router
  const originalPushState = history.pushState;
  const originalReplaceState = history.replaceState;

  history.pushState = function() {
    originalPushState.apply(this, arguments);
    log('PushState interceptado');
    setTimeout(() => trackVisit(), 100);
  };

  history.replaceState = function() {
    originalReplaceState.apply(this, arguments);
    log('ReplaceState interceptado');
    setTimeout(() => trackVisit(), 100);
  };
})();
</script>
  </body>
</html>



