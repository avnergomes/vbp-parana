<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vbp-parana/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Dashboard de Inteligência Territorial da Produção Agropecuária do Paraná" />
    <title>VBP Paraná - Inteligência Territorial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  </head>
  <body class="antialiased">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script>
(function() {
  const TRACKING_URL = 'https://script.google.com/macros/s/AKfycbzT3O9M4tN-eYXLXoxAH9v2zdjfqFm0URPQrEPvnl1ZsVqXaJyb7QHDHnYDSJSRoacnYA/exec';
  const DEBUG = true; // Mude para false em produção

  function log(message, data) {
    if (DEBUG) {
      console.log('[VBP Tracking]', message, data || '');
    }
  }

  function getSessionId() {
    let sessionId = sessionStorage.getItem('vbp_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('vbp_session_id', sessionId);
      log('Novo sessionId criado:', sessionId);
    } else {
      log('SessionId existente:', sessionId);
    }
    return sessionId;
  }

  function trackVisit(page) {
    const visitData = {
      page: page || window.location.pathname + window.location.hash,
      referrer: document.referrer || 'direto',
      userAgent: navigator.userAgent,
      language: navigator.language,
      screenWidth: screen.width,
      screenHeight: screen.height,
      platform: navigator.platform,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      sessionId: getSessionId(),
      timestamp: new Date().toISOString()
    };

    log('Enviando dados:', visitData);

    fetch(TRACKING_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(visitData)
    })
    .then(() => {
      log('Requisição enviada com sucesso (no-cors - sem resposta)');
    })
    .catch(error => {
      log('Erro ao enviar:', error);
    });
  }

  // Rastrear visita inicial
  log('Inicializando rastreamento');
  trackVisit();

  // Rastrear mudanças de hash (para rotas #hash)
  window.addEventListener('hashchange', function() {
    log('Hash mudou');
    trackVisit();
  });

  // Rastrear mudanças de rota no React Router (popstate)
  window.addEventListener('popstate', function() {
    log('Popstate disparado');
    setTimeout(() => trackVisit(), 100);
  });

  // Interceptar pushState e replaceState para React Router
  const originalPushState = history.pushState;
  const originalReplaceState = history.replaceState;

  history.pushState = function() {
    originalPushState.apply(this, arguments);
    log('PushState interceptado');
    setTimeout(() => trackVisit(), 100);
  };

  history.replaceState = function() {
    originalReplaceState.apply(this, arguments);
    log('ReplaceState interceptado');
    setTimeout(() => trackVisit(), 100);
  };
})();
</script>
  </body>
</html>
